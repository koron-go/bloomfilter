# VBF3 Redis についての覚え書き

## VBF3 Redisのパフォーマンス測定&改良

VBF3 RedisのPutはVBF2 Redisの13倍遅い。

```console
$ go test -v -run no -bench 'Benchmark(VBF3)?RedisPut'
goos: windows
goarch: amd64
pkg: github.com/koron-go/bloomfilter
cpu: Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz
BenchmarkRedisPut
BenchmarkRedisPut-16                2233            518175 ns/op
BenchmarkVBF3RedisPut
BenchmarkVBF3RedisPut-16             184           6715018 ns/op
PASS
ok      github.com/koron-go/bloomfilter 3.211s
```

もともとコマンド1個で書くだけだったのが、読んで書いてを各k回行うようになり、
ベンチマークでは `k = 7` なので妥当な速度低下。

まとめて読み書きするように直してみるか。

BitField を2回にしてみた結果3倍程度まで圧縮できた。

```console
$ go test -v -run no -bench 'Benchmark(VBF3)?RedisPut'
goos: windows
goarch: amd64
pkg: github.com/koron-go/bloomfilter
cpu: Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz
BenchmarkRedisPut
BenchmarkRedisPut-16                2293            516261 ns/op
BenchmarkVBF3RedisPut
BenchmarkVBF3RedisPut-16             783           1510346 ns/op
PASS
ok      github.com/koron-go/bloomfilter 2.675s
```

## VBF3 (Redis)の解説

VBF3 (Volatile Bloom Filter 3) は8ビットのVBF2として実装されています。
VBF2 の詳細は [VBF2の実装詳細][vbf2-details]を参照してください。
以下ではそれを踏まえた上でVBF3の実装詳細を解説します。

[vbf2-details]:(https://github.com/koron-go/bloomfilter/blob/master/README.md#vbf2%E3%81%AE%E5%AE%9F%E8%A3%85%E8%A9%B3%E7%B4%B0)

### VBF3 の実装詳細

VBF3は忘却機能付きのブルームフィルタです。
通常のブルームフィルターではデータを性質の異なる複数の関数で整数値に射影し複数のインデックスを得ます。
そうして求めた複数のインデックスをビット配列のインデックスとして該当する複数のビットを `1`にします。
特定のデータに対して求められる全部のインデックスについて配列の対応するビットがすべて1であれば、
そのデータが集合に含まれるという判定になります。

VBF3では格納する値をブーリアンから8ビットの非負整数へ変更しています。
整数はそのインデックスの **世代** を示しており、
これにより世代を区切って有効なインデックスを判定できるようにしています。
この有効とみなす世代区間を **有効区間** とします。
実際に格納している **世代** は `0` を無効を示す値として除外し
`1` ~ `255` でアナログ時計の文字盤のような[剰余類環][rrmod]を構成しています。 
**有効区間** もこの剰余類環上の範囲として設定されています。
またこの範囲の外側は **無効区間** としており、
当然有効区間が広ければ無効区間は狭くなるという性質があります。

[rrmod]:https://ja.wikipedia.org/wiki/%E5%89%B0%E4%BD%99%E9%A1%9E%E7%92%B0

VBF3には以下の主要な操作(メソッド)が提供されています

* `Open` - 既存のVBF3を開くもしくは新規のものを作成する

    `有効区間` の幅を指定してVBF3インスタンスを作成できます。

* `Put` - データをVBF3に登録する

    忘却までの寿命を設定してデータを登録します。
    最大寿命は `Open` で指定した有効区間の幅`に制限されます。

    ストレージに格納する世代はより新しいものが優先されます。

* `Check` - データ登録の有無を確認する

* `AdvanceGeneration` - 世代を進める

    有効区間を更新して忘却を実行します。
    ストレージに記憶したインデックスの世代ではなく有効区間のみを更新することで高速な忘却を実現しています。

* `Sweep` - 無効区間にあるインデックスをすべて `0` にリセットする

「世代を進める」という操作を実施することで疑似的な忘却を実現しています。
具体的には有効区間に加法を行うことを「世代を進める」としており、
有効区間が幅を保ったまま指定した世代だけ前進します。
これは時計で言えば針が進むことに相当します。
有効区間が進んだ結果、
一部のインデックスの世代は区間外に追いやられインデックスが無効になり、
そのインデックスの元になったデータはVBF3インスタンス内に存在しないことになります。
このようにストレージに記憶したインデックスの世代ではなく、
有効区間のみを更新することで高速な忘却を実現しています。

世代を進め続けると一度区間を外れた世代が1周して再び有効区間内に入ることが想定さ
れます。
そうなる前に `Sweep` 操作を用いて、無効区間にある世代を持つインデックスを `0` クリアすることで無効化します。
有効区間が広いほど無効区間が狭くなるため `Sweep` 無しに進められる世代数が少なくなり、結果的に `Sweep` の利用回数は増えます。

### VBF3 Redisについての補足事項

VBF3 Redisでは世代や有効区間などの情報を永続化・プロセス間共有するのにRedisを用
いています。
VBF3を構成する基本パラメーターと有効区間はそれぞれ個別のキーにJSONで格納しています。
基本パラメーターは一度作ってしまった後は読み取り専用で、有効区間は世代を進める操作で随時更新されます。

インデックスの世代情報は複数のキーにまたがる場合があります。
これはRedisが最大512MBのバイト配列しか格納できない制限によるもので、
ブルームフィルタの `m` パラメーターが大きい場合に 512MB ごとに区切って
複数保存しています。
